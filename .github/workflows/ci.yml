name: CI

on:
  pull_request:
    branches: ["master"]

env:
  ZIG_VERSION: "0.15.2"

jobs:
  version-check:
    name: Version Bump Check
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Check Version Bump
        run: |
          PR_VERSION=$(sed -n 's/.*\.version = "\([^"]*\)".*/\1/p' build.zig.zon)
          git fetch origin master
          MASTER_VERSION=$(git show origin/master:build.zig.zon | sed -n 's/.*\.version = "\([^"]*\)".*/\1/p')
          echo "PR version: $PR_VERSION"
          echo "Master version: $MASTER_VERSION"
          if [ "$PR_VERSION" = "$MASTER_VERSION" ]; then
            echo "::error::Version not bumped! Update .version in build.zig.zon"
            exit 1
          fi
          echo "Version bump verified: $MASTER_VERSION -> $PR_VERSION"

  test:
    name: Test (${{ matrix.os }}, ${{ matrix.optimize }})
    needs: version-check
    strategy:
      fail-fast: false
      matrix:
        os: [ubuntu-latest, macos-latest, windows-latest]
        optimize: [Debug, ReleaseSafe]
        include:
          - os: ubuntu-latest
            optimize: ReleaseFast
          - os: ubuntu-latest
            optimize: ReleaseSmall
    runs-on: ${{ matrix.os }}
    steps:
      - uses: actions/checkout@v4
        with:
          submodules: recursive
      - uses: mlugg/setup-zig@v2
        with:
          version: ${{ env.ZIG_VERSION }}
      - name: Build
        run: zig build -Doptimize=${{ matrix.optimize }}
      - name: Test
        run: zig build test -Doptimize=${{ matrix.optimize }}
      - name: Test Conformance
        run: zig build test-conformance -Doptimize=${{ matrix.optimize }}

  fuzz:
    name: Fuzz
    needs: version-check
    runs-on: ubuntu-latest
    continue-on-error: true
    steps:
      - uses: actions/checkout@v4
      - uses: mlugg/setup-zig@v2
        with:
          version: ${{ env.ZIG_VERSION }}
      - name: Fuzz Test
        timeout-minutes: 1
        run: zig build fuzz

  format:
    name: Format
    needs: version-check
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: mlugg/setup-zig@v2
        with:
          version: ${{ env.ZIG_VERSION }}
      - name: Check Format
        run: zig fmt --check src/

  package:
    name: Package
    needs: version-check
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          path: source

      - uses: mlugg/setup-zig@v2
        with:
          version: ${{ env.ZIG_VERSION }}

      - name: Create Test Consumer
        run: |
          mkdir test-consumer
          cd test-consumer
          cat > build.zig.zon << 'EOF'
          .{
              .name = .test_consumer,
              .version = "0.0.0",
              .fingerprint = 0xe5383c71d14e21dc,
              .dependencies = .{
                  .toon_zig = .{ .path = "../source" },
              },
              .paths = .{""},
          }
          EOF

          cat > build.zig << 'EOF'
          const std = @import("std");
          pub fn build(b: *std.Build) void {
              const target = b.standardTargetOptions(.{});
              const optimize = b.standardOptimizeOption(.{});
              const toon_zig = b.dependency("toon_zig", .{
                  .target = target,
                  .optimize = optimize,
              });
              _ = toon_zig;
          }
          EOF

      - name: Build Consumer
        working-directory: test-consumer
        run: zig build
